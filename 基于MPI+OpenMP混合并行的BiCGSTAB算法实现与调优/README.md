# ğŸ”„ åŸºäºMPI+OpenMPæ··åˆå¹¶è¡Œçš„BiCGSTABç®—æ³•å®ç°ä¸è°ƒä¼˜

[![Language](https://img.shields.io/badge/Language-C%2B%2B-blue.svg)](https://en.cppreference.com/)
[![OpenMP](https://img.shields.io/badge/OpenMP-4.5+-green.svg)](https://www.openmp.org/)
[![MPI](https://img.shields.io/badge/MPI-OpenMPI%204.0+-orange.svg)](https://www.open-mpi.org/)

æœ¬é¡¹ç›®å®ç°äº†BiCGSTABï¼ˆåŒå…±è½­æ¢¯åº¦ç¨³å®šåŒ–ï¼‰è¿­ä»£æ±‚è§£å™¨çš„å¤šå±‚æ¬¡å¹¶è¡Œä¼˜åŒ–ï¼Œé€šè¿‡ç³»ç»Ÿæ€§çš„æ€§èƒ½åˆ†æå’Œä¼˜åŒ–ç­–ç•¥ï¼Œæ¢ç´¢äº†ä»ä¸²è¡Œåˆ°OpenMPã€MPIä»¥åŠæ··åˆå¹¶è¡Œæ¨¡å‹çš„å®Œæ•´æ€§èƒ½è°ƒä¼˜è¿‡ç¨‹ã€‚

## ğŸ“Š æ ¸å¿ƒæˆæœ

| ä¼˜åŒ–é˜¶æ®µ | é…ç½® | è¿è¡Œæ—¶é—´ | åŠ é€Ÿæ¯” | æ€§èƒ½ç‰¹ç‚¹ |
|----------|------|----------|--------|----------|
| **ä¸²è¡Œç‰ˆæœ¬** | 1æ ¸å¿ƒ | 379.384s | 1.0x | åˆå§‹åŸºå‡† |
| **ç¼–è¯‘å™¨ä¼˜åŒ–** | 1æ ¸å¿ƒ (-O2) | 93.877s | 4.04x | ç¼–è¯‘å™¨è‡ªåŠ¨ä¼˜åŒ– |
| **OpenMPå¹¶è¡Œ** | 96çº¿ç¨‹ | **3.488s** | **108.8x** | ğŸ† æœ€ä¼˜æ€§èƒ½ |
| **MPI+OpenMPæ··åˆ** | 2è¿›ç¨‹Ã—48çº¿ç¨‹ | 12.5s | 30.4x | é€šä¿¡å¼€é”€æ˜æ˜¾ |

## ğŸ¯ é¡¹ç›®äº®ç‚¹

- **ğŸ” ç³»ç»Ÿæ€§æ€§èƒ½åˆ†æ**: ä½¿ç”¨Intel VTune Profilerå®šä½æ€§èƒ½ç“¶é¢ˆï¼Œ99%è®¡ç®—æ—¶é—´é›†ä¸­åœ¨`gemv`å‡½æ•°
- **âš¡ å¤šå±‚æ¬¡å¹¶è¡Œä¼˜åŒ–**: ä»ç¼–è¯‘å™¨ä¼˜åŒ–åˆ°OpenMPã€MPIåŠæ··åˆå¹¶è¡Œçš„å®Œæ•´å®è·µ
- **ğŸ“ˆ é‡åŒ–æ€§èƒ½è¯„ä¼°**: è¯¦ç»†çš„å¯æ‰©å±•æ€§åˆ†æå’Œå¹¶è¡Œæ•ˆç‡è®¡ç®—
- **ğŸ› ï¸ å®é™…å·¥ç¨‹æŒ‘æˆ˜**: è§£å†³äº†MPIç¯å¢ƒé…ç½®ã€SLURMè°ƒåº¦ç­‰å®é™…éƒ¨ç½²é—®é¢˜

## ğŸ—ï¸ é¡¹ç›®ç»“æ„

```
åŸºäºMPI+OpenMPæ··åˆå¹¶è¡Œçš„BiCGSTABç®—æ³•å®ç°ä¸è°ƒä¼˜/
â”œâ”€â”€ README.md                    # é¡¹ç›®è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ assets/                      # å›¾è¡¨å’Œå¯è§†åŒ–ç»“æœ
â”‚   â”œâ”€â”€ image-20250909214805195.png  # VTuneæ€§èƒ½åˆ†æ-åˆå§‹ç‰ˆæœ¬
â”‚   â”œâ”€â”€ image-20250909214825105.png  # VTuneæ€§èƒ½åˆ†æ-ç¼–è¯‘å™¨ä¼˜åŒ–å
â”‚   â”œâ”€â”€ e4290bf6-2957-4838-85fb-46c52c9d77d2.png  # OpenMPå¯æ‰©å±•æ€§åˆ†æå›¾è¡¨
â”‚   â”œâ”€â”€ image-20250909214914518.png  # OpenMPæ€§èƒ½å¯¹æ¯”
â”‚   â””â”€â”€ image-20250909214930548.png  # ITACé€šä¿¡åˆ†ææŠ¥å‘Š
â”œâ”€â”€ code/                        # æºä»£ç å’Œæ„å»ºé…ç½®
â”‚   â”œâ”€â”€ src/                     # C++æºä»£ç 
â”‚   â”‚   â”œâ”€â”€ main.cpp            # ä¸»ç¨‹åºå…¥å£
â”‚   â”‚   â”œâ”€â”€ judger.cpp          # æ€§èƒ½æµ‹è¯•æ¨¡å—
â”‚   â”‚   â””â”€â”€ bicgstab/           # BiCGSTABç®—æ³•å®ç°
â”‚   â”œâ”€â”€ include/                 # å¤´æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ judger.h
â”‚   â”œâ”€â”€ CMakeLists.txt          # CMakeæ„å»ºé…ç½®
â”‚   â”œâ”€â”€ compile.sh              # ç¼–è¯‘è„šæœ¬
â”‚   â”œâ”€â”€ run.sh                  # è¿è¡Œè„šæœ¬
â”‚   â”œâ”€â”€ run_benchmark.sh        # æ€§èƒ½åŸºå‡†æµ‹è¯•
â”‚   â”œâ”€â”€ run_mpi.sh             # MPIè¿è¡Œè„šæœ¬
â”‚   â””â”€â”€ run_vtune.sh           # VTuneæ€§èƒ½åˆ†æè„šæœ¬
â”œâ”€â”€ report/                      # å®éªŒæŠ¥å‘Š
â”‚   â””â”€â”€ åŸºäºMPI+OpenMPæ··åˆå¹¶è¡Œçš„BiCGSTABç®—æ³•å®ç°ä¸è°ƒä¼˜.md
â””â”€â”€ result/                      # å®éªŒç»“æœå’Œæ•°æ®
    â”œâ”€â”€ data/                   # æµ‹è¯•æ•°æ®é›†
    â”‚   â”œâ”€â”€ case_2001.bin      # 2001ç»´ç¨€ç–çŸ©é˜µ
    â”‚   â”œâ”€â”€ case_4001.bin      # 4001ç»´ç¨€ç–çŸ©é˜µ
    â”‚   â””â”€â”€ case_6001.bin      # 6001ç»´ç¨€ç–çŸ©é˜µ
    â”œâ”€â”€ reports/               # VTuneæ€§èƒ½åˆ†ææŠ¥å‘Š
    â””â”€â”€ reports_time/          # è¿è¡Œæ—¶é—´ç»Ÿè®¡ç»“æœ
```

## âš™ï¸ æŠ€æœ¯æ ˆ

- **ç¼–ç¨‹è¯­è¨€**: C++14/17
- **å¹¶è¡Œç¼–ç¨‹æ¨¡å‹**: OpenMP 4.5+, MPI (OpenMPI)
- **æ„å»ºç³»ç»Ÿ**: CMake 3.15+
- **æ€§èƒ½åˆ†æå·¥å…·**: Intel VTune Profiler, Intel ITAC
- **ä½œä¸šè°ƒåº¦ç³»ç»Ÿ**: SLURM
- **ç¼–è¯‘å™¨**: GCC 9+ æˆ– Intel ICC

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

```bash
# å¿…éœ€ä¾èµ–
sudo apt-get install build-essential cmake
sudo apt-get install libopenmpi-dev openmpi-bin
sudo apt-get install libomp-dev

# å¯é€‰ï¼šæ€§èƒ½åˆ†æå·¥å…·
# Intel VTune Profiler (éœ€è¦å•ç‹¬å®‰è£…)
# Intel ITAC (Intel MPIå·¥å…·é“¾çš„ä¸€éƒ¨åˆ†)
```

### ç¼–è¯‘ä¸è¿è¡Œ

```bash
# ç¼–è¯‘é¡¹ç›®
cd code
mkdir build && cd build
cmake ..
make

# ä¸²è¡Œè¿è¡Œ
./bicgstab_solver

# OpenMPå¹¶è¡Œè¿è¡Œ (96çº¿ç¨‹)
export OMP_NUM_THREADS=96
./bicgstab_solver

# MPIè¿è¡Œ (16è¿›ç¨‹)
mpirun -np 16 ./bicgstab_solver

# MPI+OpenMPæ··åˆè¿è¡Œ (2è¿›ç¨‹ Ã— 48çº¿ç¨‹)
export OMP_NUM_THREADS=48
mpirun -np 2 ./bicgstab_solver
```

### æ€§èƒ½åŸºå‡†æµ‹è¯•

```bash
# è¿è¡Œå®Œæ•´çš„æ€§èƒ½åŸºå‡†æµ‹è¯•
cd code
./run_benchmark.sh

# VTuneæ€§èƒ½åˆ†æ
./run_vtune.sh

# SLURMé›†ç¾¤ç¯å¢ƒè¿è¡Œ
sbatch run_mpi.sh
```

## ğŸ“ˆ æ€§èƒ½åˆ†æç»“æœ

### OpenMPå¯æ‰©å±•æ€§åˆ†æ

| çº¿ç¨‹æ•° | è¿è¡Œæ—¶é—´ | åŠ é€Ÿæ¯” | å¹¶è¡Œæ•ˆç‡ |
|--------|----------|--------|----------|
| 1 | 93.076s | 1.00x | 100.0% |
| 8 | 12.423s | 7.49x | 93.6% |
| 16 | 6.559s | 14.60x | 91.3% |
| 32 | 4.626s | 20.12x | 62.9% |
| 64 | 3.692s | 25.21x | 39.4% |
| 96 | **3.488s** | **26.04x** | 27.1% |

### å…³é”®å‘ç°

1. **ğŸ¯ æ€§èƒ½ç“¶é¢ˆå®šä½**: 99%çš„è®¡ç®—æ—¶é—´é›†ä¸­åœ¨çŸ©é˜µå‘é‡ä¹˜æ³•(`gemv`)å‡½æ•°
2. **ğŸš€ OpenMPä¼˜åŠ¿**: åœ¨å•èŠ‚ç‚¹å†…å®ç°è¿‘ä¼¼çº¿æ€§åŠ é€Ÿï¼Œæœ€é«˜è¾¾åˆ°108.8å€åŠ é€Ÿ
3. **ğŸŒ é€šä¿¡å¼€é”€æŒ‘æˆ˜**: MPIé€šä¿¡æˆä¸ºæ€§èƒ½ç“¶é¢ˆï¼Œ`MPI_Allgatherv`è€—æ—¶å·¨å¤§
4. **âš–ï¸ æ··åˆæ¨¡å‹æƒè¡¡**: "å°‘è¿›ç¨‹ã€å¤šçº¿ç¨‹"ç­–ç•¥ç¼“è§£é€šä¿¡å‹åŠ›ä½†æ— æ³•è¶…è¶Šçº¯OpenMP

## ğŸ”¬ ç®—æ³•å®ç°ç»†èŠ‚

### BiCGSTABæ ¸å¿ƒç®—æ³•
```cpp
// OpenMPå¹¶è¡ŒåŒ–çš„çŸ©é˜µå‘é‡ä¹˜æ³•
#pragma omp parallel for
for (int i = 0; i < n; i++) {
    double sum = 0.0;  // çº¿ç¨‹ç§æœ‰ç´¯åŠ å™¨
    for (int j = row_ptr[i]; j < row_ptr[i+1]; j++) {
        sum += values[j] * x[col_idx[j]];
    }
    y[i] = sum;
}
```

### MPIåˆ†å¸ƒå¼ç­–ç•¥
- **æ•°æ®åˆ†å¸ƒ**: æŒ‰è¡Œåˆ†è§£ç­–ç•¥ï¼Œä½¿ç”¨`MPI_Scatterv`åˆ†å‘æ•°æ®
- **å…¨å±€é€šä¿¡**: `MPI_Allreduce`å®ç°ç‚¹ç§¯å½’çº¦ï¼Œ`MPI_Allgatherv`æ”¶é›†å‘é‡
- **è´Ÿè½½å‡è¡¡**: æ ¹æ®ç¨€ç–çŸ©é˜µéé›¶å…ƒåˆ†å¸ƒè¿›è¡ŒåŠ¨æ€è´Ÿè½½åˆ†é…

## ğŸ“š BiCGSTABç®—æ³•æ•°å­¦åŸºç¡€

### ç®—æ³•æè¿°

BiCGSTAB (Biconjugate Gradient Stabilized) æ˜¯ä¸€ç§ç”¨äºæ±‚è§£éå¯¹ç§°çº¿æ€§ç³»ç»Ÿ $Ax = b$ çš„Krylovå­ç©ºé—´è¿­ä»£æ–¹æ³•ã€‚

#### ç®—æ³•æ­¥éª¤:

1. $r_0 = b - \mathbf{A}x_0$
2. Choose an arbitrary vector $\hat{r_0}$ such that $(\hat{r_0}, r_0)\ne 0$, eg. $\hat{r_0} = r_0$
3. $\rho_0 = (\hat{r}_0, r_0)$
4. $p_0 = r_0$
5. For $i = 1, 2, 3, \ldots$
    1. $y = \mathbf{M^{-1}} p_{i-1}$
    2. $v = \mathbf{A}{y}$
    3. $\alpha = \rho_{i-1} / (\hat{r}_0, v)$
    4. $h = x_{i-1} + \alpha y$
    5. $s = r_{i-1} - \alpha v$
    6. If $s$ is within the accuracy tolerance then $x_{i-1} = h$ and quit.
    7. $z = \mathbf{M^{-1}} s$
    8. $t = \mathbf{A}z$
    9. $\omega = (t, s) / (t, t)$
    10. $x_i = h + \omega z$
    11. $r_i = s - \omega t$
    12. If $r_i$ is within the accuracy tolerance then quit.
    13. $\rho_i = (\hat{r}_0, r_i)$
    14. $\beta = (\rho_i / \rho_{i-1}) (\alpha / \omega)$
    15. $p_i = r_i + \beta (p_{i-1} - \omega v)$

## ğŸ› ï¸ å¼€å‘ç¯å¢ƒé…ç½®

### Intel VTune Profileré›†æˆ
```bash
# ä½¿ç”¨VTuneè¿›è¡Œæ€§èƒ½åˆ†æ
vtune -collect hotspots -app-args ./bicgstab_solver
vtune -report hotspots -r r000hs
```

### SLURMä½œä¸šé…ç½®
```bash
#!/bin/bash
#SBATCH --job-name=bicgstab_hybrid
#SBATCH --nodes=2
#SBATCH --ntasks-per-node=1
#SBATCH --cpus-per-task=48
#SBATCH --time=01:00:00

export OMP_NUM_THREADS=48
mpirun -np 2 ./bicgstab_solver
```



**æ•°æ®æ–‡ä»¶**ï¼š
- æµ‹è¯•æ•°æ®ä½äº `/river/hpc101/2025/lab4/data`
- å¯é€šè¿‡ `ln -s /river/hpc101/2025/lab4/data data` å¼•ç”¨
- æäº¤æ—¶è¯·å‹¿åŒ…å«æ•°æ®æ–‡ä»¶



## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT License å¼€æºåè®®ã€‚

---

**ä½œè€…**: è‹æ˜“æ–‡ (å­¦å·: 3240103466)  
**è¯¾ç¨‹**: é«˜æ€§èƒ½è®¡ç®— - æµ™æ±Ÿå¤§å­¦  
**å®Œæˆæ—¶é—´**: 2025å¹´9æœˆ
